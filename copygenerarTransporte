import { Injectable, HttpException, InternalServerErrorException, BadRequestException } from '@nestjs/common';
import { PrismaNovasoftService } from 'src/prismaNovasoft/prismaNovasoft.service';
import { getCurrentMonth, getNowDate, formatoDateToDDMMYYYY } from 'src/utils/date.util'; 
import { generarIngresoDto } from './dto/generaringreso.dto';
import { PrismaAuraquanticService } from 'src/prismaAuraquantic/prismaAuraquantic.service';

@Injectable()
export class GenerarIngresoService {
  constructor(
    private readonly prismaNovasoftService: PrismaNovasoftService,
    private readonly prismaAuraquanticService: PrismaAuraquanticService

  ) {}

  


  async generarIngreso(data: generarIngresoDto ) {
    const { referencia, tipoIngreso, ano_o, per_o, num_o, solicitante, _ElementID} = data;

    
  const tip_doc = '008';
  const vendedor = 0;
  const cod_cl2 = 0;
  const cod_cl3 = 0;
  const asig_num = 1;
  const ind_refac = 0;
  const conv_cco = 0;
  const conv_cl1 = 0;
  const conv_cl2 = 0;
  const conv_cl3 = 0;
  const por_adm = 0;
  const por_imp = 0;
  const cliente = 0;
  const bod_des = 0;
  const lista = 0;
  const ind_mp = '00';
  const tasa = 0;
  const fac_pro = 0;
  const cod_caja = 0;
  const cant_uni = 0;
  const alterno = 0;
  const trans = 32002;
  const fac_con = 0;
  const por_com = 0;
  const fec_ent = '1900-01-01 00:00:00.000';
  const suc_des = 0;
  const cod_conv = 0;
  const conv_suc = 0;
  const por_uti = 0;
  const mon_adm = 0;
  const mon_imp = 0;
  const mon_uti = 0;
  const usr_ano_ped = 0;
  const usr_per_ped = 0;
  const usr_sub_ped = 0;
  const usr_pedido = 0;
  const usr_reg_ped = 0;
  const sub_cdp = 'U726';
 
  const clean = (val) =>
    val === null || val === undefined || String(val).trim() === '' 
      ? null 
      : String(val).trim();
  
  
// Obtener asig_numero desde inv_inf_inv usando la referencia
const resultadoAsig = await this.prismaNovasoftService.$queryRawUnsafe<any[]>(`
    SELECT TOP 1 asig_numero
    FROM inv_inf_inv
    WHERE obs_orc LIKE '%' + '${referencia}' + '%'
  `);
  
  if (!resultadoAsig || resultadoAsig.length === 0) {
    throw new Error(`No se encontró asig_numero para la referencia ${referencia}`);
  }
  
  const asigNumero = resultadoAsig[0].asig_numero;
  
  // Determinar cod_sub según el prefijo de asig_numero
  let cod_sub = '';
  if (asigNumero.startsWith('OS') || asigNumero.startsWith('OC')) {
    cod_sub = 'C008';
  } else if (asigNumero.startsWith('PF')) {
    cod_sub = 'PFIN';
  } else if (asigNumero.startsWith('CN')) {
    cod_sub = 'NCIN';
  } else {
    throw new Error(`No se pudo determinar el sub_tip para asig_numero ${asigNumero}`);
  }
  
  console.log('AsigNumero:', asigNumero, 'CodSub:', cod_sub);
  

    
    const cantidadesAura = await this.prismaAuraquanticService.$queryRawUnsafe<any[]>(`
        SELECT ID, 
        [2_ART_CON_GAN/TXT_UP_ARTICULO] + ' - ' + [1_ART_CON_GAN/Name] codItem, 
        [2_ART_CON_GAN/CANTIDAD_ART] CantidadT, 
        ISNULL([2_ART_CON_GAN/ENT_CANT_ERP], 0) CantidadI, 
        ISNULL([2_ART_CON_GAN/ENT_CANT_RECIBIDA], 0) CantidadR, 
        ISNULL([2_ART_CON_GAN/TXT_NUM_FACTURA], '') factura 
FROM Panel_109_68508_83802 
        WHERE [_ElementID] = ${_ElementID}
        ORDER BY ID
      `);
      

      

    //Consulta de items
    const consultaitems = `
    DECLARE @sub_o CHAR(5);
    DECLARE @ano_o CHAR(4) = '${ano_o}';
    DECLARE @per_o CHAR(2) = '${per_o}';
    DECLARE @num_o CHAR(14) = '${num_o}';
    DECLARE @fec_a DATE = '${formatoDateToDDMMYYYY()}';
    DECLARE @sub_a CHAR(5) = '${cod_sub}';
    DECLARE @tip_a CHAR(5) = (SELECT cod_tip FROM gen_subtipodoc WHERE cod_sub = '${cod_sub}');
    DECLARE @Referencia CHAR(20) = '${referencia}';
    

    IF EXISTS   (
                SELECT sub_tip 
                FROM inv_inf_inv 
                WHERE   asig_numero = @num_o 
                AND tip_doc = '007' 
                AND obs_orc LIKE '%' + @Referencia + '%' )	
BEGIN 
    SELECT @sub_o = sub_tip 
    FROM inv_inf_inv 
    WHERE   asig_numero = @num_o 
    AND tip_doc = '007' 
    AND obs_orc LIKE '%' + @Referencia + '%'; 	
END; 
ELSE 
BEGIN 
    SELECT @sub_o = sub_tip 
    FROM inv_cuedoc 
    WHERE  num_doc = @num_o 
    AND tip_doc = '007'
    AND ano_doc = @ano_o 
    AND per_doc = @per_o 
END; 
SELECT      CONVERT(CHAR(4), FORMAT(@fec_a, 'yyyy')) ano_doc, CONVERT(CHAR(2), FORMAT(@fec_a, 'MM')) per_doc, @sub_a sub_tip, @tip_a tip_doc, '' num_doc, 
            CUE.reg_doc, CONVERT(VARCHAR(MAX), @fec_a, 112) fecha, CAB.vendedor, CAB.cod_suc, CUE.cod_cco, 
            CUE.cod_cl1, CUE.cod_cl2, CUE.cod_cl3, CAB.cliente, CAB.provee, 
            CAB.lista, CAB.dia_pla, CAB.ind_mp, CONVERT(VARCHAR(MAX), CAB.fec_tas, 112) fec_tas, CAB.tasa, 
            CAB.obs_orc, CAB.fac_pro, CAB.cod_caja, CUE.bodega, CUE.bod_des, 
            CUE.cant_uni, CUE.item, CUE.alterno, '32002' trans, CONVERT(INT, CUE.cantidad) cantidad, 
            + CUE.fac_con, CUE.cos_uni, CUE.pre_vta, CUE.por_des, CUE.por_iva, 
            CUE.por_iva_ng, CUE.por_ret, CUE.por_com, CUE.cos_unai, CONVERT(VARCHAR(MAX), CUE.fec_ent, 112) fec_ent, 
            CUE.suc_des, CUE.ven_lote, CUE.cod_lote, '' ind_tra, 1 asig_num, 
            CUE.ind_refac, CUE.cod_conv, CUE.conv_suc, CUE.conv_cco, CUE.conv_cl1, 
            CUE.conv_cl2, CUE.conv_cl3, CUE.num_fact, CUE.ord_fact, CUE.por_adm, 
            CUE.por_imp, CUE.por_uti, CUE.mon_adm, CUE.mon_imp, CUE.mon_uti, 
            NULL asig_numero, CUE.ind_afe, @ano_o usr_ano_ped, @per_o usr_per_ped, @sub_o usr_sub_ped, 
            @num_o usr_pedido, CUE.reg_doc usr_reg_ped, '${solicitante}' usr_tercero, NULL ano_cdp, NULL per_cdp, 
            CUE.sub_cdp, CUE.num_cdp, CUE.cod_rubro, NULL usr_ano_des, NULL usr_per_des, 
            NULL usr_sub_des, NULL usr_despa, NULL usr_reg_des, CUE.descrip_cue usr_descrip_cue 
FROM   inv_cuedoc CUE 
    INNER JOIN inv_cabdoc CAB ON (
                                        CUE.ano_doc = CAB.ano_doc 
                                        AND CUE.per_doc = CAB.per_doc 
                                        AND CUE.sub_tip = CAB.sub_tip 
                                        AND CUE.num_doc = CAB.num_doc
                                    )
WHERE   CAB.ano_doc = @ano_o 
        AND CAB.per_doc = @per_o 
        AND CAB.sub_tip = @sub_o 
        AND CAB.num_doc = @num_o




    ` 
    const items = await this.prismaNovasoftService.$queryRawUnsafe<any[]>(`
    ${consultaitems}`);



    const cantidadAura = cantidadesAura.length;
    const cantidadNova = items.length;
    
    if (cantidadAura !== cantidadNova) {
      return {
        mensaje: `La cantidad de items de la orden '${referencia}' no es igual en ambos sistemas, no se puede generar el ingreso.`,
        referencia,
        cantidadAura,
        cantidadNova,
      };
    }

    let num_doc = null;



if (tipoIngreso.toLowerCase() === 'completo') {

  const consecutivo = await this.prismaNovasoftService.$queryRawUnsafe<any[]>(`
    SELECT ISNULL(MAX(CONVERT(INT, num_doc)), 0) + 1 AS numDoc
    FROM inv_inf_inv
  `);

  num_doc = consecutivo[0]?.numDoc;

  // Validación estricta
  if (!num_doc || isNaN(num_doc)) {
    throw new Error("Error al generar el consecutivo. No se puede continuar.");
  }


  for (let i = 0; i < cantidadesAura.length; i++) {
    const aura = cantidadesAura[i];
    const nova = items[i]; // Los datos que se usan para el INSERT
  
    const CantidadT = Number(aura.CantidadT);
    const CantidadI = Number(aura.CantidadI);
  
    // Validación
    if ((CantidadT - CantidadI) <= 0) continue;
  
    const CantidadR = CantidadT - CantidadI;
    const nuevaCantidadI = CantidadI + CantidadR;


  
  
    // Insert
   console.log(`
    INSERT INTO inv_inf_inv (
 
             ano_doc, per_doc, tip_doc, sub_tip, num_doc, reg_doc,
        fecha, vendedor, cod_suc, cod_cco, cod_cl1, cod_cl2,
        cod_cl3, cliente, provee, lista, dia_pla, ind_mp,
        fec_tas, tasa, obs_orc, bodega, bod_des, fac_pro,
        cod_caja, cant_uni, item, alterno, trans, cantidad,
        fac_con, cos_uni, pre_vta, por_des, por_iva, por_iva_ng,
        por_ret, por_com, cos_unai, fec_ent, suc_des, ind_tra,
        asig_num, ind_refac, cod_conv, conv_suc, conv_cco, conv_cl1,
        conv_cl2, conv_cl3, num_fact, ord_fact, por_adm, por_imp,
        por_uti, mon_adm, mon_imp, mon_uti, usr_ano_ped, usr_per_ped,
        usr_sub_ped, usr_pedido, usr_reg_ped, usr_tercero, 
        cod_rubro, usr_descrip_cue, sub_cdp, num_cdp
      )
     VALUES (


        '${getNowDate().getFullYear()}', '${getCurrentMonth()}', '${tip_doc}','${cod_sub}', '${num_doc}', '${nova.reg_doc}', 
        '${formatoDateToDDMMYYYY()}','${nova.vendedor}', '${clean(nova.cod_suc)}', '${clean(nova.cod_cco)}', '${nova.cod_cl1}', '${cod_cl2}', 
        '${cod_cl3}','${cliente}', '${nova.provee}', '${lista}','${nova.dia_pla}', '${ind_mp}', 
        '${formatoDateToDDMMYYYY()}', '${tasa}', '${nova.obs_orc}','${nova.bodega}', '${bod_des}', '${fac_pro}', 
        '${cod_caja}', '${cant_uni}', '${nova.item}', '${alterno}', '${trans}', '${CantidadR}', 
        '${fac_con}', '${nova.cos_uni}', '${nova.pre_vta}', '${nova.por_des}', '${nova.por_iva}','${nova.por_iva_ng}',
        '${nova.por_ret}', '${por_com}', '${nova.cos_unai}', '${nova.fec_ent}', '${nova.suc_des}', '',        
        '${asig_num}', '${ind_refac}', '${cod_conv}', '${conv_suc}','${conv_cco}', '${conv_cl1}', 
        '${conv_cl2}', '${conv_cl3}', NULL, NULL ,'${por_adm}', '${por_imp}',
        '${por_uti}', '${mon_adm}', '${mon_imp}', '${mon_uti}','${usr_ano_ped}','${usr_per_ped}', 
        '${usr_sub_ped}', '${usr_pedido}', '${usr_reg_ped}','${nova.usr_tercero}',
        '${clean(nova.cod_rubro)}', '${nova.usr_descrip_cue}', '${nova.sub_cdp}', '${nova.num_cdp}'
    )
    `);
   
    await this.prismaNovasoftService.$executeRawUnsafe(`
      INSERT INTO inv_inf_inv (

             ano_doc, per_doc, tip_doc, sub_tip, num_doc, reg_doc,
        fecha, vendedor, cod_suc, cod_cco, cod_cl1, cod_cl2,
        cod_cl3, cliente, provee, lista, dia_pla, ind_mp,
        fec_tas, tasa, obs_orc, bodega, bod_des, fac_pro,
        cod_caja, cant_uni, item, alterno, trans, cantidad,
        fac_con, cos_uni, pre_vta, por_des, por_iva, por_iva_ng,
        por_ret, por_com, cos_unai, fec_ent, suc_des, ind_tra,
        asig_num, ind_refac, cod_conv, conv_suc, conv_cco, conv_cl1,
        conv_cl2, conv_cl3, num_fact, ord_fact, por_adm, por_imp,
        por_uti, mon_adm, mon_imp, mon_uti, usr_ano_ped, usr_per_ped,
        usr_sub_ped, usr_pedido, usr_reg_ped, usr_tercero, 
        cod_rubro, usr_descrip_cue, sub_cdp, num_cdp
      )
     VALUES (


        '${getNowDate().getFullYear()}', '${getCurrentMonth()}', '${tip_doc}','${cod_sub}', '${num_doc}', '${nova.reg_doc}', 
        '${formatoDateToDDMMYYYY()}','${nova.vendedor}', '${clean(nova.cod_suc)}', '${clean(nova.cod_cco)}', '${nova.cod_cl1}', '${cod_cl2}', 
        '${cod_cl3}','${cliente}', '${nova.provee}', '${lista}','${nova.dia_pla}', '${ind_mp}', 
        '${formatoDateToDDMMYYYY()}', '${tasa}', '${nova.obs_orc}','${nova.bodega}', '${bod_des}', '${fac_pro}', 
        '${cod_caja}', '${cant_uni}', '${nova.item}', '${alterno}', '${trans}', '${CantidadR}', 
        '${fac_con}', '${nova.cos_uni}', '${nova.pre_vta}', '${nova.por_des}', '${nova.por_iva}','${nova.por_iva_ng}',
        '${nova.por_ret}', '${por_com}', '${nova.cos_unai}', '${nova.fec_ent}', '${nova.suc_des}', '',        
        '${asig_num}', '${ind_refac}', '${cod_conv}', '${conv_suc}','${conv_cco}', '${conv_cl1}', 
        '${conv_cl2}', '${conv_cl3}', NULL, NULL ,'${por_adm}', '${por_imp}',
        '${por_uti}', '${mon_adm}', '${mon_imp}', '${mon_uti}','${usr_ano_ped}','${usr_per_ped}', 
        '${usr_sub_ped}', '${usr_pedido}', '${usr_reg_ped}','${nova.usr_tercero}',
        '${clean(nova.cod_rubro)}', '${nova.usr_descrip_cue}', '${nova.sub_cdp}', '${nova.num_cdp}'
    )
    `);
  }
}




return {
    Codigo: `200`,
    Mensaje: `Consulta realiza con éxito`,
    num_doc
    
};

} catch(error) {
        console.error("Error al generar la orden:", error.mensaje);
        if (error instanceof HttpException) throw error;

        console.log('Error al reasignar el cdp', error);
        throw new InternalServerErrorException('Error al generar la consulta')


    } 

}
