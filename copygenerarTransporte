// --- VALIDAR QUE EL ÍTEM EXISTA ---
const itemInfo = await this.prismaNovasoftService.$queryRawUnsafe<any[]>(`
    SELECT cod_est, cod_ret_com, por_ret, por_iva, por_iva_ng
    FROM inv_items
    WHERE cod_item = '${itemLimpio}'
`);

if (itemInfo.length === 0) {
    throw new BadRequestException(`El item ${itemLimpio} no existe`);
}

// --- VALIDAR SI EL ÍTEM ESTÁ ACTIVO ---
const estadoItem = itemInfo[0].cod_est;  // Ej: 'A' activo, 'I' inactivo

if (estadoItem !== 'A') {
    throw new BadRequestException(`El item ${itemLimpio} no está activo`);
}