for (const aura of cantidadesAuraParcial) {

  const CantidadT = Number(aura.CantidadT || 0); // Total
  const CantidadI = Number(aura.CantidadI || 0); // Ya ingresado
  const CantidadR = Number(aura.CantidadR || 0); // Recibido ahora
  const factura = (aura.factura || '').trim();

  // Validar factura
  if (!factura) {
    console.warn(`Factura vacía para item ${aura.codItem}`);
    continue;
  }

  const facturasValidas = consulfactura.map(f => (f.factura || '').trim().toUpperCase());
  if (!facturasValidas.includes(factura.toUpperCase())) {
    console.warn(`Factura no válida: ${factura} para item ${aura.codItem}`);
    throw new BadRequestException(`Factura no válida: ${factura} para item ${aura.codItem}`);
  }

  const CantidadIActualizada = CantidadI + CantidadT;
  const CantidadPendiente = CantidadR - CantidadIActualizada;

  // Depuración de cantidades
  console.log('===== DEBUG SUMA Y RESTA PARCIAL =====');
  console.log({
    item: aura.codItem,
    CantidadT,
    CantidadI,
    CantidadR,
    CantidadIActualizada,
    CantidadPendiente
  });

  if (CantidadPendiente <= 0) {
    console.warn(`CantidadPendiente <= 0 para item ${aura.codItem}`);
    continue; // O lanzar un BadRequest si quieres bloquear el flujo
  }

  const codigoAura = String(aura.codItem).split(' - ')[0].trim();
  const normalizar = (v: string) => v.replace(/\s+/g, '').toUpperCase();
  const novas = items.filter(i => normalizar(i.item) === normalizar(codigoAura));

  if (novas.length === 0) {
    console.warn(`No se encontró item correspondiente en Nova para ${codigoAura}`);
    throw new BadRequestException(`No se encontró item correspondiente en Nova para ${codigoAura}`);
  }

  let restante = CantidadPendiente;

  for (const nova of novas) {
    if (restante <= 0) break;

    const cantidadNova = Number(nova.cantidad || 0);
    if (cantidadNova <= 0) {
      console.warn(`cantidadNova <= 0 para item ${nova.item}`);
      continue;
    }

    const yaIngresado = mapIngresado.get(codigoAura) || 0;
    const pendienteRealERP = CantidadPendiente - yaIngresado;

    if (pendienteRealERP <= 0) {
      console.warn(`pendienteRealERP <= 0 para item ${nova.item}`);
      continue;
    }

    const cantidadInsertar = pendienteRealERP > 0 ? pendienteRealERP : 0;
    if (cantidadInsertar <= 0) {
      console.warn(`cantidadInsertar <= 0 para item ${nova.item}`);
      continue;
    }

    // Aquí iría tu insert
    console.log(`Preparado para insertar item ${nova.item} cantidad: ${cantidadInsertar}`);
  }
}