// 1️⃣ Consultar órdenes
const consultaOrdenes = await this.prismaAuraquanticService.$queryRawUnsafe<any[]>(`
    SELECT DISTINCT
        RTRIM(p110_70611.[3_NumeroOrdenContenedor]) AS orden
    FROM AP__BPM_Procesos p
    INNER JOIN Panel_110 p110
        ON p110.[_ElementID] = p.[ID]
    INNER JOIN Panel_110_70611 p110_70611
        ON p110_70611.[_ElementID] = p110.[ID]
    WHERE p.Referencia = '${Referencia}'
`);

const ordenes: string[] = consultaOrdenes.map(o => o.orden);

// Si no hay órdenes
if (ordenes.length === 0) {
    return {
        Codigo: '200',
        Mensaje: 'No hay órdenes',
        estadoFinal: 0
    };
}

// 2️⃣ Consultar ingresos normalizados
const consultaIngreso = await this.prismaNovasoftService.$queryRawUnsafe<any[]>(`
    SELECT DISTINCT
        RTRIM(usr_pedido) AS usr_pedido,
        RTRIM(asig_numero) AS asig_numero
    FROM inv_inf_inv
    WHERE obs_orc = '${obs_orc}'
      AND RTRIM(usr_pedido) IN (${ordenes.map(o => `'${o}'`).join(',')})
`);

// 3️⃣ Evaluar estado final
let estadoFinal = 1;

for (const orden of ordenes) {
    const ingreso = consultaIngreso.find(i => i.usr_pedido === orden);

    if (
        !ingreso ||
        ingreso.asig_numero === null ||
        ingreso.asig_numero === undefined ||
        ingreso.asig_numero.trim() === ''
    ) {
        estadoFinal = 0;
        break;
    }
}

// 4️⃣ Respuesta final
return {
    Codigo: '200',
    Mensaje: 'Consulta realizada con éxito',
    ordenes,
    estadoFinal
};