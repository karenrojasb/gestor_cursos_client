else if (tipoIngreso.toLowerCase() === 'parcial') {

  const consecutivo = await this.prismaNovasoftService.$queryRawUnsafe<any[]>(`
    SELECT ISNULL(MAX(CONVERT(INT, num_doc)), 0) + 1 AS numDoc
    FROM inv_inf_inv
  `);

  num_doc = consecutivo[0]?.numDoc;
  if (!num_doc || isNaN(num_doc)) {
    throw new BadRequestException("Error al generar consecutivo para ingreso parcial.");
  }

  const hayFactura = cantidadesAuraParcial.some(a => (a.factura || '').trim() !== '');
  if (!hayFactura) {
    throw new BadRequestException(`No se encontró ninguna factura válida para la referencia ${obs_orc} y la OC ${num_o}`);
  }

  for (const aura of cantidadesAuraParcial) {

    const CantidadT = Number(aura.CantidadT || 0);
    const CantidadI = Number(aura.CantidadI || 0);
    const CantidadR = Number(aura.CantidadR || 0);
    const factura = (aura.factura || '').trim();

    // Validación básica
    if (!factura) {
      console.warn(`Item ${aura.codItem} tiene factura vacía, se omite`);
      continue;
    }
    if (CantidadR <= 0) {
      console.warn(`Item ${aura.codItem} con CantidadR <= 0, se omite`);
      continue;
    }

    const facturasValidas = consulfactura.map(f => (f.factura || '').trim().toUpperCase());
    if (!facturasValidas.includes(factura.toUpperCase())) {
      throw new BadRequestException(`Factura inválida para item ${aura.codItem}: ${factura}`);
    }

    
    const CantidadPendiente = CantidadR - CantidadT;

    if (CantidadPendiente <= 0) continue;

    const codigoAura = String(aura.codItem).split(' - ')[0].trim();
    const normalizar = (v: string) => 
    v.replace(/;;/g, '')
    .replace(/\s+/g, '')
    .toUpperCase();
    const novas = items.filter(i => normalizar(i.item) === normalizar(codigoAura));

    if (novas.length === 0) {
      throw new BadRequestException(`Item no encontrado en ERP para código ${codigoAura}`);
    }

    let restante = CantidadPendiente;

    for (const nova of novas) {
  

     //Agregar validación para que si el el CantidadT es superior a CantidadR mande un mensaje diciendo que no se puede generar orden que supera el limite de cantidad
  //insert PARCIAL
    await this.prismaNovasoftService.$executeRawUnsafe(`      
      INSERT INTO inv_inf_inv (
        ano_doc, per_doc, tip_doc, sub_tip, num
