// 1️⃣ Consultar órdenes por referencia
const consultaOrdenes = await this.prismaAuraquanticService.$queryRawUnsafe<any[]>(`
    SELECT DISTINCT
        p110_70611.[3_NumeroOrdenContenedor] AS orden
    FROM AP__BPM_Procesos p
    INNER JOIN Panel_110 p110
        ON p110.[_ElementID] = p.[ID]
    INNER JOIN Panel_110_70611 p110_70611
        ON p110_70611.[_ElementID] = p110.[ID]
    WHERE p.Referencia = '${Referencia}'
`);

const ordenes: string[] = consultaOrdenes.map(o => o.orden);
const totalOrdenes = ordenes.length;


// 2️⃣ Consultar qué órdenes tienen ingreso
let ordenesConIngreso: string[] = [];

if (ordenes.length > 0) {
    const consultaIngreso = await this.prismaNovasoftService.$queryRawUnsafe<any[]>(`
        SELECT DISTINCT usr_pedido
        FROM inv_inf_inv 
        WHERE obs_orc = '${obs_orc}'
        AND usr_pedido IN (${ordenes.map(o => `'${o}'`).join(',')})
        AND asig_numero IS NOT NULL
    `);

    ordenesConIngreso = consultaIngreso.map(i => i.usr_pedido);
}

const totalIngresos = ordenesConIngreso.length;


// 3️⃣ Determinar estado correctamente
// 0 = sin ingresos
// 1 = completo
// 2 = parcial
let estado = 0;

if (totalOrdenes > 0) {
    if (ordenesConIngreso.length === 0) {
        estado = 0; // ninguna orden tiene ingreso
    } else if (ordenesConIngreso.length === totalOrdenes) {
        estado = 1; // todas las órdenes tienen ingreso
    } else {
        estado = 2; // algunas sí, otras no (parcial)
    }
}


// 4️⃣ Respuesta
return {
    Codigo: '200',
    Mensaje: 'Consulta realizada con éxito',
    totalOrdenes,
    totalIngresos,
    ordenes,
    ordenesConIngreso,
    estado
};