// 1️⃣ Consulta de IDs en AuraQuantic antes de items
const gcpmIds = await this.prismaAuraquanticService.$queryRawUnsafe<{ ID: number }[]>(`
  SELECT GC_PM.ID
  FROM Panel_109_68508 GC_PM
  INNER JOIN Panel_109 PA ON PA.ID = GC_PM._ElementID
  INNER JOIN AP__BPM_Procesos P ON P.ID = PA._ElementID
  WHERE P.Referencia = '${referencia}'
`);

if (!gcpmIds || gcpmIds.length === 0) {
  throw new Error(`No se encontraron IDs en AuraQuantic para la referencia ${referencia}`);
}

// Ahora tienes los IDs que normalmente daban el paso 2
// Puedes acceder al primer ID así (si es que solo necesitas uno)
const gcpmId = gcpmIds[0].ID;

// 2️⃣ Usar gcpmId para filtrar tu consulta de ítems de Novasoft
// Por ejemplo, si tu query de items depende de este ID, podrías hacer algo así:

const consultaitems = `
  DECLARE @sub_o CHAR(5);
  DECLARE @ano_o CHAR(4) = '${ano_o}';
  DECLARE @per_o CHAR(2) = '${per_o}';
  DECLARE @num_o CHAR(14) = '${num_o}';
  DECLARE @fec_a DATE = '${formatoDateToDDMMYYYY()}';
  DECLARE @sub_a CHAR(5) = '${cod_sub[0].cod_sub}';
  DECLARE @tip_a CHAR(5) = (SELECT cod_tip FROM gen_subtipodoc WHERE cod_sub = '${cod_sub[0].cod_sub}');
  DECLARE @referencia CHAR(20) = '${referencia}';
  DECLARE @gcpmId INT = ${gcpmId}; -- usamos el ID de AuraQuantic

  -- Aquí tu lógica de items usando @gcpmId si hace falta
  SELECT ...
  FROM Panel_109_68508_68526
  WHERE [_ElementID] = @gcpmId
`;

const items = await this.prismaNovasoftService.$queryRawUnsafe<any[]>(consultaitems);