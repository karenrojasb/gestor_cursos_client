SELECT
CONVERT(VARCHAR(10), PA.Creado, 103) AS [Fecha de creación del Proceso],
TP.FechaInicio,
P.Referencia AS [Referencia del Proceso],
E.FullName AS [Solicitante],
Sol.FullName AS [Nombre del Empleado],
GC.[2_Empleado_Horas/Código ERP] AS [Cédula de Ciudania],
GC.[3_Actividad_Extra] AS [Actividad Realizada],
CONVERT(VARCHAR(20),DATEADD(HOUR, -5, [3_Entrada_Extra]), 22) AS [Fecha y Hora de Entrada],
CONVERT(VARCHAR(20), DATEADD(HOUR, -5, [3_Salida_Extra]), 22) AS [Fecha y Hora de Salida],
GC.[3_Horas_Extras] AS [Horas Solicitadas],
ISNULL(GC.[3_Horas_RH], 0) AS [Horas aprobadas por RRHH],
ISNULL(DOP.Opcion, '') AS [Jornada Laboral],
ISNULL(GC.[3_Observaciones_Extras], 'N/A') AS [Observaciones Solicitante],
ISNULL(PA.[3_Observaciones_HorasExtras], 'N/A') AS [Observaciones de RRHH],
DO.Opcion AS [Concepto Jefe Inmediato],
PA.[3_Observaciones_Jefe] AS [Observaciones Superior Inmediato],
EA.ResponsibleName AS [Aprobado Superior Inmediato],
CASE P.IdEstado
    WHEN 0 THEN 'En curso'
    ELSE 'Terminada'
END AS [Estado Proceso]
FROM AP__BPM_Procesos P
INNER JOIN Panel_100 PA ON P.ID = PA._ElementID
INNER JOIN Panel_100_71312 GC ON GC._ElementID = PA.ID
INNER JOIN (
    SELECT IdClaseTarea, 
           MAX(FechaInicio) FechaInicio, 
           IdProceso,  
           MAX(ID) ID, 
           IdEstado  
    FROM AP__BPM_TareaPersonal
    WHERE IdClaseTarea ='1239'
    GROUP BY IdClaseTarea, IdProceso, IdEstado
) TP ON (TP.IdProceso = P.ID and TP.IdClaseTarea ='1239')
INNER JOIN AP__BPM_ParticipantesAsignar PR ON (TP.ID=PR.IdElemento and PR.Perfil='1')
INNER JOIN AP__EmployeeTreeLevelToGuid EM ON EM.LocationGuid = PR.ValorParticipante
INNER JOIN AP__Employees_Tree EA ON EA.ID = EM.ID
INNER JOIN AP__Diccionario_Terminos_Opciones DO ON DO.ID = PA.[3_Aprobación_Jefe]
INNER JOIN AP__Diccionario_Terminos_Opciones DOP ON DOP.ID = GC.[3_Jornada_Laboral]
INNER JOIN AP__Employee E ON E.ID = PA.IdCreador
INNER JOIN AP__Employee Sol ON Sol.[ERPCode] = GC.[2_Empleado_Horas/Código ERP]
WHERE PA.[3_Tipo_Solicitud] ='1413'
AND TP.IdEstado NOT IN ('3','4')
