import { Injectable, HttpException, InternalServerErrorException, BadRequestException } from '@nestjs/common';
import { PrismaNovasoftService } from 'src/prismaNovasoft/prismaNovasoft.service';
import { getCurrentMonth, getNowDate, formatoDateToDDMMYYYY } from 'src/utils/date.util'; 
import { generarIngresotransporteDto } from './dto/generaringresotransporte.dto';
import { PrismaAuraquanticService } from 'src/prismaAuraquantic/prismaAuraquantic.service';

@Injectable()
export class GenerarIngresotransporteService {
  constructor(
    private readonly prismaNovasoftService: PrismaNovasoftService,
    private readonly prismaAuraquanticService: PrismaAuraquanticService

  ) {}

  

  async generarIngreso(data: generarIngresotransporteDto ) {
    const { referencia,  solicitante, 
      sub_tip, cod_cco, usr_pedido, num_fact, cod_cl1, provee, num_cdp, cod_rubro,
    item, cantidad, cos_uni, dia_pla, por_des, bodega, usr_descrip_cue } = data;

    //Funcion para limpiar los valores
  const clean = (val) =>
    val === null || val === undefined || String(val).trim() === '' 
      ? null 
      : String(val).trim();
  

      

  
  // Obtener asig_numero desde inv_inf_inv usando la referencia
  const resultadoAsig = await this.prismaNovasoftService.$queryRawUnsafe<any[]>(`
      SELECT TOP 1 asig_numero
      FROM inv_inf_inv
      WHERE obs_orc LIKE '%' + '${referencia}' + '%'
    `);
    
    if (!resultadoAsig || resultadoAsig.length === 0) {
      throw new Error(`No se encontró asig_numero para la referencia ${referencia}`);
    }
    
    const asigNumero = resultadoAsig[0].asig_numero;
    

  

    //Obtener el per_doc
    const per_o = await this.prismaNovasoftService.$queryRawUnsafe<any[]>(`
      SELECT TOP 1 per_doc
      FROM inv_inf_inv
      WHERE obs_orc LIKE '%' + '${referencia}' + '%'
    `);
    
    if (!per_o || per_o.length === 0) {
      throw new Error(`No se encontró per_doc para la referencia ${referencia}`);
    }
    
    const perDoc = per_o[0].per_doc;

    //Obtener el ano_doc
    const ano_o = await this.prismaNovasoftService.$queryRawUnsafe<any[]>(`
      SELECT TOP 1 ano_doc
      FROM inv_inf_inv
      WHERE obs_orc LIKE '%' + '${referencia}' + '%'
    `);
    
    if (!ano_o || ano_o.length === 0) {
      throw new Error(`No se encontró ano_doc para la referencia ${referencia}`);
    }
    
    const anoDoc = ano_o[0].ano_doc;


    //Obtener la cantidad 
    const cantidadNova = await this.prismaNovasoftService.$queryRawUnsafe<any[]>(`
      SELECT TOP 1 cantidad 
      FROM inv_inf_inv
      WHERE obs_orc LIKE '%' + '${referencia}' + '%'`
      );
      if (!cantidadNova || cantidadNova.length === 0) {
        throw new Error(`No se encontró cantidad para la referencia ${referencia}`);
      }
      const cantidad_Nova = cantidadNova[0].cantidad;
      
  

      

    //consulta de items
    const consultaitems = `
    DECLARE @sub_o CHAR(5);
    DECLARE @ano_o CHAR(4) = '${anoDoc}';
    DECLARE @per_o CHAR(2) = '${perDoc}';
    DECLARE @num_o CHAR(14) = '${usr_pedido}';
    DECLARE @fec_a DATE = '${formatoDateToDDMMYYYY()}';
    DECLARE @sub_a CHAR(5) = '${sub_tip}';
    DECLARE @tip_a CHAR(5) = (SELECT cod_tip FROM gen_subtipodoc WHERE cod_sub = '${sub_tip}');
    DECLARE @Referencia CHAR(20) = '${referencia}';
    

    IF EXISTS   (
                SELECT sub_tip 
                FROM inv_inf_inv 
                WHERE   asig_numero = @num_o 
                AND tip_doc = '007' 
                AND obs_orc LIKE '%' + @Referencia + '%' )	
BEGIN 
    SELECT @sub_o = sub_tip 
    FROM inv_inf_inv 
    WHERE   asig_numero = @num_o 
    AND tip_doc = '007' 
    AND obs_orc LIKE '%' + @Referencia + '%'; 	
END; 
ELSE 
BEGIN 
    SELECT @sub_o = sub_tip 
    FROM inv_cuedoc 
    WHERE  num_doc = @num_o 
    AND tip_doc = '007'
    AND ano_doc = @ano_o 
    AND per_doc = @per_o 
END; 
SELECT      CONVERT(CHAR(4), FORMAT(@fec_a, 'yyyy')) ano_doc, CONVERT(CHAR(2), FORMAT(@fec_a, 'MM')) per_doc, @sub_a sub_tip, @tip_a tip_doc, '' num_doc, 
            CUE.reg_doc, CONVERT(VARCHAR(MAX), @fec_a, 112) fecha, CAB.vendedor, CAB.cod_suc, CUE.cod_cco, 
            CUE.cod_cl1, CUE.cod_cl2, CUE.cod_cl3, CAB.cliente, CAB.provee, 
            CAB.lista, CAB.dia_pla, CAB.ind_mp, CONVERT(VARCHAR(MAX), CAB.fec_tas, 112) fec_tas, CAB.tasa, 
            CAB.obs_orc, CAB.fac_pro, CAB.cod_caja, CUE.bodega, CUE.bod_des, 
            CUE.cant_uni, CUE.item, CUE.alterno, '32002' trans, CONVERT(INT, CUE.cantidad) cantidad, 
            + CUE.fac_con, CUE.cos_uni, CUE.pre_vta, CUE.por_des, CUE.por_iva, 
            CUE.por_iva_ng, CUE.por_ret, CUE.por_com, CUE.cos_unai, CONVERT(VARCHAR(MAX), CUE.fec_ent, 112) fec_ent, 
            CUE.suc_des, CUE.ven_lote, CUE.cod_lote, '' ind_tra, 1 asig_num, 
            CUE.ind_refac, CUE.cod_conv, CUE.conv_suc, CUE.conv_cco, CUE.conv_cl1, 
            CUE.conv_cl2, CUE.conv_cl3, CUE.num_fact, CUE.ord_fact, CUE.por_adm, 
            CUE.por_imp, CUE.por_uti, CUE.mon_adm, CUE.mon_imp, CUE.mon_uti, 
            NULL asig_numero, CUE.ind_afe, @ano_o usr_ano_ped, @per_o usr_per_ped, @sub_o usr_sub_ped, 
            @num_o usr_pedido, CUE.reg_doc usr_reg_ped, '${solicitante}' usr_tercero, NULL ano_cdp, NULL per_cdp, 
            CUE.sub_cdp, CUE.num_cdp, CUE.cod_rubro, NULL usr_ano_des, NULL usr_per_des, 
            NULL usr_sub_des, NULL usr_despa, NULL usr_reg_des, CUE.descrip_cue usr_descrip_cue 
FROM   inv_cuedoc CUE 
    INNER JOIN inv_cabdoc CAB ON (
                                        CUE.ano_doc = CAB.ano_doc 
                                        AND CUE.per_doc = CAB.per_doc 
                                        AND CUE.sub_tip = CAB.sub_tip 
                                        AND CUE.num_doc = CAB.num_doc
                                    )
WHERE   CAB.ano_doc = @ano_o 
        AND CAB.per_doc = @per_o 
        AND CAB.sub_tip = @sub_o 
        AND CAB.num_doc = @num_o


    `
    

    
    const items = await this.prismaNovasoftService.$queryRawUnsafe<any[]>(`
    ${consultaitems}`);

    let num_doc = null;

  
//Validar que la cantidad ingresada sea la misma que la cantidad registrada en Nova
if (Number(cantidad) !== Number(cantidad_Nova)) {
  throw new BadRequestException(
    `La cantidad ingresada (${cantidad}) no coincide con la cantidad registrada en Nova (${cantidad_Nova}). El consecutivo no puede generarse.`
  );
}
  //Generar el consecutivo
  const consecutivo = await this.prismaNovasoftService.$queryRawUnsafe<any[]>(`
    SELECT ISNULL(MAX(CONVERT(INT, num_doc)), 0) + 1 AS numDoc
    FROM inv_inf_inv
  `);
  
  num_doc = consecutivo[0]?.numDoc;
  



  for (let i = 0; i < items.length; i++) {
    const nova = items[i];     
  
    
  
    // Insert
    await this.prismaNovasoftService.$executeRawUnsafe(`
      
INSERT INTO inv_inf_inv (
  ano_doc, per_doc, tip_doc, sub_tip, num_doc, reg_doc,
  fecha, vendedor, cod_suc, cod_cco, cod_cl1, cod_cl2,
  cod_cl3, cliente, provee, lista, dia_pla, ind_mp,
  fec_tas, tasa, obs_orc, bodega, bod_des, fac_pro,
  cod_caja, cant_uni, item, alterno, trans, cantidad,
  fac_con, cos_uni, pre_vta, por_des, por_iva, por_iva_ng,
  por_ret, por_com, cos_unai, fec_ent, suc_des, ind_tra,
  asig_num, ind_refac, cod_conv, conv_suc, conv_cco, conv_cl1,
  conv_cl2, conv_cl3, num_fact, ord_fact, por_adm, por_imp,
  por_uti, mon_adm, mon_imp, mon_uti, usr_ano_ped, usr_per_ped,
  usr_sub_ped, usr_pedido, usr_reg_ped, usr_tercero, 
  cod_rubro, usr_descrip_cue, sub_cdp, num_cdp
)
VALUES (
  '${clean(nova.ano_doc)}', '${clean(nova.per_doc)}', '${clean(nova.tip_doc)}', '${sub_tip}', '${clean(num_doc)}', '${clean(nova.reg_doc)}', 
  '${formatoDateToDDMMYYYY()}', '${nova.vendedor}', '${clean(nova.cod_suc)}', '${cod_cco}',
  '${cod_cl1}', '${nova.cod_cl2}', '${clean(nova.cod_cl3)}', '${clean(nova.cliente)}', '${provee}', 
  '${clean(nova.lista)}', '${dia_pla}', '${nova.ind_mp}',
  '${nova.fec_tas}', '${nova.tasa}', '${clean(nova.obs_orc)}', '${bodega}', '${clean(nova.bod_des)}', '${clean(nova.fac_pro)}',
  '${clean(nova.cod_caja)}', '${nova.cant_uni}', '${nova.item}', '${clean(nova.alterno)}', '${nova.trans}', '${cantidad}', 
  '${nova.fac_con}', '${cos_uni}', '${nova.pre_vta}', '${por_des}', '${nova.por_iva}', '${nova.por_iva_ng}',
  '${clean(nova.por_ret)}', '${nova.por_com}', '${nova.cos_unai}', '${nova.fec_ent}', '${nova.suc_des}', '${nova.ind_tra}',
  '${nova.asig_num}', '${nova.ind_refac ? 1 : 0}', '${nova.cod_conv}', '${nova.conv_suc}', '${clean(nova.conv_cco)}', '${nova.conv_cl1}',
  '${nova.conv_cl2}', '${nova.conv_cl3}', ${num_fact}, NULL, '${nova.por_adm}', '${nova.por_imp}',
  '${nova.por_uti}', '${nova.mon_adm}', '${nova.mon_imp}', '${nova.mon_uti}','${nova.usr_ano_ped}','${nova.usr_per_ped}', 
  '${nova.usr_sub_ped}', '${usr_pedido}', '${nova.usr_reg_ped}', '${nova.usr_tercero}',
  '${cod_rubro}', '${usr_descrip_cue}', '${nova.sub_cdp}', '${num_cdp}'
);

  `);
  console.log (`INSERT INTO inv_inf_inv (
    ano_doc, per_doc, tip_doc, sub_tip, num_doc, reg_doc,
    fecha, vendedor, cod_suc, cod_cco, cod_cl1, cod_cl2,
    cod_cl3, cliente, provee, lista, dia_pla, ind_mp,
    fec_tas, tasa, obs_orc, bodega, bod_des, fac_pro,
    cod_caja, cant_uni, item, alterno, trans, cantidad,
    fac_con, cos_uni, pre_vta, por_des, por_iva, por_iva_ng,
    por_ret, por_com, cos_unai, fec_ent, suc_des, ind_tra,
    asig_num, ind_refac, cod_conv, conv_suc, conv_cco, conv_cl1,
    conv_cl2, conv_cl3, num_fact, ord_fact, por_adm, por_imp,
    por_uti, mon_adm, mon_imp, mon_uti, usr_ano_ped, usr_per_ped,
    usr_sub_ped, usr_pedido, usr_reg_ped, usr_tercero, 
    cod_rubro, usr_descrip_cue, sub_cdp, num_cdp
  )
  VALUES (
    '${clean(nova.ano_doc)}', '${clean(nova.per_doc)}', '${clean(nova.tip_doc)}', '${sub_tip}', '${clean(num_doc)}', '${clean(nova.reg_doc)}', 
    '${formatoDateToDDMMYYYY()}', '${nova.vendedor}', '${clean(nova.cod_suc)}', '${cod_cco}',
    '${cod_cl1}', '${nova.cod_cl2}', '${clean(nova.cod_cl3)}', '${clean(nova.cliente)}', '${provee}', 
    '${clean(nova.lista)}', '${dia_pla}', '${nova.ind_mp}',
    '${nova.fec_tas}', '${nova.tasa}', '${clean(nova.obs_orc)}', '${bodega}', '${clean(nova.bod_des)}', '${clean(nova.fac_pro)}',
    '${clean(nova.cod_caja)}', '${nova.cant_uni}', '${nova.item}', '${clean(nova.alterno)}', '${nova.trans}', '${cantidad}', 
    '${nova.fac_con}', '${cos_uni}', '${nova.pre_vta}', '${por_des}', '${nova.por_iva}', '${nova.por_iva_ng}',
    '${clean(nova.por_ret)}', '${nova.por_com}', '${nova.cos_unai}', '${nova.fec_ent}', '${nova.suc_des}', '${nova.ind_tra}',
    '${nova.asig_num}', '${nova.ind_refac ? 1 : 0}', '${nova.cod_conv}', '${nova.conv_suc}', '${clean(nova.conv_cco)}', '${nova.conv_cl1}',
    '${nova.conv_cl2}', '${nova.conv_cl3}', ${num_fact}, NULL, '${nova.por_adm}', '${nova.por_imp}',
    '${nova.por_uti}', '${nova.mon_adm}', '${nova.mon_imp}', '${nova.mon_uti}','${nova.usr_ano_ped}','${nova.usr_per_ped}', 
    '${nova.usr_sub_ped}', '${usr_pedido}', '${nova.usr_reg_ped}', '${nova.usr_tercero}',
    '${cod_rubro}', '${usr_descrip_cue}', '${nova.sub_cdp}', '${num_cdp}'
  );`)
  
}

//GEjecutar procedimiento almacenado
await this.prismaNovasoftService.$queryRawUnsafe<any[]>(`
  EXEC dbo.USR_sp_gen_afeinv_preciso 
      @iano_doc = '${getNowDate().getFullYear()}',
      @fano_doc = '${getNowDate().getFullYear()}',
      @iper_doc = '${getCurrentMonth()}',
      @fper_doc = '${getCurrentMonth()}',
      @isub_tip = '${sub_tip}',
      @fsub_tip = '${sub_tip}',
      @inum_doc = '${num_doc}',
      @fnum_doc = '${num_doc}',
      @ifec_doc = '${formatoDateToDDMMYYYY()}',
      @ffec_doc = '${formatoDateToDDMMYYYY()}',
      @indver = 0
`);


const asigNumeroResult = await this.prismaNovasoftService.$queryRawUnsafe<any[]>(`
  SELECT DISTINCT asig_numero
  FROM inv_inf_inv
  WHERE ind_tra = 'X'
    AND ano_doc = ${getNowDate().getFullYear()}
    AND per_doc = '${getCurrentMonth()}'
    AND sub_tip = '${sub_tip}'
    AND num_doc = ${num_doc}
`);

// Si no encuentra nada, dejar en blanco
const asig_numero = asigNumeroResult.length > 0
  ? asigNumeroResult[0].asig_numero
  : '';

return {
    Codigo: `200`,
    Mensaje: `Consulta realiza con éxito`,
    asig_numero
    
};

} catch (error) {
  console.error("Error al generar la orden:", error.message);

  if (error instanceof HttpException) throw error;

  throw new InternalServerErrorException(
    `Error al generar la consulta: ${error.message}`,
  );
}

}
